#!/bin/bash

RES_DIR="/etc/dhcp/reservations"
DHCP_SERVICE="isc-dhcp-server"
CONF_FILE="/etc/dhcp/dhcpd.conf"

usage() {
    echo "Usage:"
    echo "  drt new [-f] <dns_name> <mac> <ip>"
    echo "  drt add <mac> <ip>"
    echo "  drt pop <ip> <mac>"
    echo "  drt update <ip> <new_value> (auto-detect DNS, IP, or MAC)"
    echo "  drt search <query>"
    echo "  drt list"
    echo "  drt delete <ip>"
    echo "  drt create-conf"
    exit 1
}

reload_dhcp() {
    systemctl reload $DHCP_SERVICE
}

list_reservations() {
    printf "%-15s %-20s %-20s\n" "IP" "MAC" "DNS Name"
    echo "---------------------------------------------------------------"
    for FILE in $RES_DIR/*.conf; do
        IP=$(basename "$FILE" .conf)
        NAME=$(grep -oP '(?<=host\s)\S+' "$FILE")
        for MAC in $(grep -oP '(?<=hardware ethernet\s)\S+' "$FILE"); do
            printf "%-15s %-20s %-20s\n" "$IP" "$MAC" "$NAME"
        done
    done
}

is_ip() {
    [[ $1 =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]]
}

is_mac() {
    [[ $1 =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]
}

case "$1" in
    new)
        FORCE=false
        shift
        if [ "$1" == "-f" ]; then
            FORCE=true
            shift
        fi
        [ $# -ne 3 ] && usage
        NAME="$1"; MAC="$2"; IP="$3"
        FILE="$RES_DIR/$IP.conf"
        if [ -f "$FILE" ] && [ "$FORCE" == "false" ]; then
            echo "Reservation for $IP exists. Use -f to overwrite."; exit 1
        fi
        cat <<EOF > "$FILE"
host $NAME {
    hardware ethernet $MAC;
    fixed-address $IP;
}
EOF
        echo "Created reservation: $NAME ($IP) -> $MAC"; reload_dhcp
        ;;

    add)
        [ $# -ne 3 ] && usage
        MAC="$2"; IP="$3"; FILE="$RES_DIR/$IP.conf"
        [ ! -f "$FILE" ] && echo "Reservation for $IP does not exist." && exit 1
        echo "    hardware ethernet $MAC;" >> "$FILE"
        echo "Added MAC $MAC to $IP"; reload_dhcp
        ;;

    pop)
        [ $# -ne 3 ] && usage
        IP="$2"; MAC="$3"; FILE="$RES_DIR/$IP.conf"
        [ ! -f "$FILE" ] && echo "Reservation for $IP does not exist." && exit 1
        sed -i "/hardware ethernet $MAC;/d" "$FILE"
        if ! grep -q "hardware ethernet" "$FILE"; then
            rm "$FILE"; echo "No MAC left. Deleted reservation for $IP"
        else
            echo "Removed MAC $MAC from $IP"
        fi
        reload_dhcp
        ;;

    update)
        [ $# -ne 3 ] && usage
        IP="$2"; NEWVAL="$3"; FILE="$RES_DIR/$IP.conf"
        [ ! -f "$FILE" ] && echo "Reservation for $IP does not exist." && exit 1
        if is_ip "$NEWVAL"; then
            sed -i "s/fixed-address .*/fixed-address $NEWVAL;/" "$FILE"
            mv "$FILE" "$RES_DIR/$NEWVAL.conf"
            echo "Updated IP from $IP to $NEWVAL"
        elif is_mac "$NEWVAL"; then
            sed -i "/hardware ethernet/d" "$FILE"
            sed -i "/fixed-address/a \    hardware ethernet $NEWVAL;" "$FILE"
            echo "Replaced all MACs for $IP with $NEWVAL"
        else
            sed -i "s/^host .*/host $NEWVAL {/" "$FILE"
            echo "Updated DNS name for $IP to $NEWVAL"
        fi
        reload_dhcp
        ;;

    search)
        [ $# -ne 2 ] && usage
        QUERY="$2"; echo "Searching for '$QUERY'..."
        list_reservations | grep -i "$QUERY" || echo "No matches found."
        ;;

    list)
        list_reservations
        ;;

    delete)
        [ $# -ne 2 ] && usage
        IP="$2"; FILE="$RES_DIR/$IP.conf"
        [ ! -f "$FILE" ] && echo "Reservation for $IP does not exist." && exit 1
        rm "$FILE"; echo "Removed reservation for $IP"; reload_dhcp
        ;;

    create-conf)
        echo "Creating DHCP configuration..."
        read -p "Domain name (default: business.lan): " DOMAIN; DOMAIN=${DOMAIN:-business.lan}
        read -p "Default lease time (default: 600): " DLT; DLT=${DLT:-600}
        read -p "Max lease time (default: 7200): " MLT; MLT=${MLT:-7200}
        read -p "Subnet (e.g., 192.168.1.0): " SUBNET
        read -p "Netmask (e.g., 255.255.255.0): " NETMASK
        read -p "DHCP range start (e.g., 192.168.1.100): " RANGE_START
        read -p "DHCP range end (e.g., 192.168.1.200): " RANGE_END
        read -p "Router IP (e.g., 192.168.1.1): " ROUTER
        read -p "Domain name servers (default: 8.8.8.8, 4.4.4.4): " DNS; DNS=${DNS:-8.8.8.8, 4.4.4.4}
        mkdir -p "$RES_DIR"
        cat <<EOF > "$CONF_FILE"
option domain-name "$DOMAIN";
option domain-name-servers $DNS;
default-lease-time $DLT;
max-lease-time $MLT;
authoritative;

subnet $SUBNET netmask $NETMASK {
    range $RANGE_START $RANGE_END;
    option routers $ROUTER;
}

include "$RES_DIR/*";
EOF
        echo "DHCP configuration created at $CONF_FILE"; systemctl restart $DHCP_SERVICE
        echo "===== Generated DHCP Configuration ====="; cat "$CONF_FILE"; echo "========================================"
        ;;

    *)
        usage
        ;;
esac

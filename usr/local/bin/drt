#!/bin/bash

RES_FILE="/etc/dhcp/reservations.conf"
DHCP_SERVICE="isc-dhcp-server"
CONF_FILE="/etc/dhcp/dhcpd.conf"

usage() {
    echo "Usage:"
    echo "  drt new [-f] <dns_name> <mac> <ip>"
    echo "  drt add <ip> <mac>"
    echo "  drt pop <ip> <mac>"
    echo "  drt update <ip> <new_value>"
    echo "  drt search <query>"
    echo "  drt list"
    echo "  drt delete <ip>"
    echo "  drt create-conf"
    exit 1
}

reload_dhcp() {
    systemctl reload $DHCP_SERVICE
}

ensure_file() {
    [ -f "$RES_FILE" ] || touch "$RES_FILE"
}

# Extract a reservation block
get_block() {
    awk "/host .* {/,/}/" "$RES_FILE"
}

list_reservations() {
    ensure_file
    printf "%-15s %-20s %-20s\n" "IP" "MAC" "DNS Name"
    echo "---------------------------------------------------------------"
    awk '
        /host/ {name=$2}
        /hardware ethernet/ {mac=$3}
        /fixed-address/ {ip=$2}
        /}/ {
            gsub(";", "", mac)
            gsub(";", "", ip)
            printf "%-15s %-20s %-20s\n", ip, mac, name
        }
    ' "$RES_FILE"
}

is_ip() {
    [[ $1 =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]]
}

is_mac() {
    [[ $1 =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]
}

delete_block() {
    local ip="$1"
    sed -i "/fixed-address $ip;/,/}/d" "$RES_FILE"
}

case "$1" in

    new)
        FORCE=false
        shift
        if [ "$1" == "-f" ]; then
            FORCE=true
            shift
        fi

        [ $# -ne 3 ] && usage
        NAME="$1"; MAC="$2"; IP="$3"

        ensure_file

        if grep -q "fixed-address $IP;" "$RES_FILE" && [ "$FORCE" == "false" ]; then
            echo "Reservation for $IP exists. Use -f to overwrite."
            exit 1
        fi

        delete_block "$IP"

        cat <<EOF >> "$RES_FILE"
host $NAME {
    hardware ethernet $MAC;
    fixed-address $IP;
}

EOF
        echo "Created reservation: $NAME ($IP) -> $MAC"
        reload_dhcp
        ;;

    add)
        [ $# -ne 3 ] && usage
        IP="$2"; MAC="$3"
        ensure_file

        if ! grep -q "fixed-address $IP;" "$RES_FILE"; then
            echo "Reservation for $IP does not exist."
            exit 1
        fi

        sed -i "/fixed-address $IP;/i\    hardware ethernet $MAC;" "$RES_FILE"

        echo "Added MAC $MAC to $IP"
        reload_dhcp
        ;;

    pop)
        [ $# -ne 3 ] && usage
        IP="$2"; MAC="$3"

        ensure_file

        if ! grep -q "fixed-address $IP;" "$RES_FILE"; then
            echo "Reservation for $IP does not exist."
            exit 1
        fi

        sed -i "/hardware ethernet $MAC;/d" "$RES_FILE"

        # If no other MAC remains, delete entire block
        if ! awk "/fixed-address $IP;/,/}/" "$RES_FILE" | grep -q "hardware ethernet"; then
            delete_block "$IP"
            echo "No MACs left, removed reservation for $IP"
        else
            echo "Removed MAC $MAC from $IP"
        fi

        reload_dhcp
        ;;

    update)
        [ $# -ne 3 ] && usage
        IP="$2"; NEWVAL="$3"
        ensure_file

        if ! grep -q "fixed-address $IP;" "$RES_FILE"; then
            echo "Reservation for $IP does not exist."
            exit 1
        fi

        BLOCK=$(awk "/fixed-address $IP;/,/}/" "$RES_FILE")

        delete_block "$IP"

        if is_ip "$NEWVAL"; then
            # Update IP only
            NEW_IP="$NEWVAL"
            echo "$BLOCK" | sed "s/fixed-address .*/fixed-address $NEW_IP;/" >> "$RES_FILE"
            echo "Updated IP $IP -> $NEW_IP"

        elif is_mac "$NEWVAL"; then
            # Replace all MACs
            echo "$BLOCK" | sed "/hardware ethernet/d" | \
            sed "/fixed-address/a\    hardware ethernet $NEWVAL;" >> "$RES_FILE"
            echo "Updated MAC for $IP -> $NEWVAL"

        else
            # Update DNS name
            NEW_NAME="$NEWVAL"
            echo "$BLOCK" | sed "s/^host .*/host $NEW_NAME {/" >> "$RES_FILE"
            echo "Updated DNS name for $IP -> $NEW_NAME"
        fi

        reload_dhcp
        ;;

    search)
        [ $# -ne 2 ] && usage
        QUERY="$2"
        ensure_file
        echo "Searching for '$QUERY'..."
        list_reservations | grep -i "$QUERY" || echo "No matches found."
        ;;

    list)
        ensure_file
        list_reservations
        ;;

    delete)
        [ $# -ne 2 ] && usage
        IP="$2"
        ensure_file

        if ! grep -q "fixed-address $IP;" "$RES_FILE"; then
            echo "Reservation for $IP does not exist."
            exit 1
        fi

        delete_block "$IP"
        echo "Deleted reservation for $IP"
        reload_dhcp
        ;;

    create-conf)
        echo "Creating DHCP configuration..."

        read -p "Domain name (default: business.lan): " DOMAIN; DOMAIN=${DOMAIN:-business.lan}
        read -p "Default lease time (default: 600): " DLT; DLT=${DLT:-600}
        read -p "Max lease time (default: 7200): " MLT; MLT=${MLT:-7200}
        read -p "Subnet (e.g., 192.168.1.0): " SUBNET
        read -p "Netmask (e.g., 255.255.255.0): " NETMASK
        read -p "DHCP range start: " RANGE_START
        read -p "DHCP range end: " RANGE_END
        read -p "Router IP: " ROUTER
        read -p "DNS servers (default: 8.8.8.8, 4.4.4.4): " DNS; DNS=${DNS:-8.8.8.8, 4.4.4.4}

        touch "
